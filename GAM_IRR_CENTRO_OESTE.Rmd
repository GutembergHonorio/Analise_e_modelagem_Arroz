---
title: "GAM_IRR_CENTRO_OESTE"
author: "Gutemberg Resende Honorio Filho"
date: "16/08/2021"
output: html_document
---

```{r}
library(tidyverse)

#library(mgcv)
library(gam)

if(!require(stats)) install.packages("stats")
if(!require(Hmisc)) install.packages("Hmisc")

```

# DADOS
```{r Diretório} 

# DIRETÓRIO DOS DADOS 

Tabelabruta<- read.csv("d:/Users/Cristiane Resende/Desktop/Gutemberg Honorio/Mestrado/Repositorio_4/Analise_e_modelagem_Arroz/Merge_1980_2018.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE) # tabela com os dados originais

# criando coluna com macrorregiões

Tabelabruta<- mutate(Tabelabruta,REGIAO = case_when(UF == 'GO'| UF == 'DF' |UF == 'MS' | UF == 'MT' ~ 'Centro-oeste',
                              UF == 'AL'| UF == 'BA' |UF == 'CE' | UF == 'MA' | UF == 'PB' | UF == 'PE' | UF == 'PI' | UF == 'RN' | UF == 'SE' ~ 'Nordeste',
                              UF == 'AC' | UF == 'AM' | UF == 'AP' | UF == 'PA' | UF == 'RO' | UF == 'RR' | UF == 'TO' ~ 'Norte',
                              UF == 'ES' | UF == 'MG' | UF == 'SP' | UF == 'RJ' ~ 'Sudeste',
                              UF == 'RS' | UF == 'SC' | UF == 'PR' ~ 'Sul'))

# Tabelas acessório

TabelabrutaIRR = subset(Tabelabruta, SIST_CULT == "IRRIGATED") # Somente Irrigado
TabelabrutaTA = subset(Tabelabruta, SIST_CULT == "UPLAND") # Somente Terras altas

# Filtrando os dados


IRR<-TabelabrutaIRR %>% mutate(UR_Media=(umidade_Media),UR_V=	(umidade_V), UR_fld_m=	(umidade_fld_m),	UR_R=	(umidade_R), Graus_dia_ciclo=(graus_dia_ciclo), Graus_dia_FLO=(graus_dia_FLO+graus_dia_IP))

IRR <- select(IRR,latitude, longitude, GENOTIPO, ID_ENSAIO,ano, Altitude, REGIAO, UF, FLO_E, Tmax_Maxima ,Tmax_fld_m ,	Tmax_R,	Tmax_ACC_R, Tmax_Minima,	Tmax_Media,Tmax_V ,Tmax_ACC_V,	Tmin_Maxima,Tmin_Minima ,	Tmin_Media ,	Tmin_V ,	Tmin_ACC_V , Tmin_fld_m ,	Tmin_R,	Tmin_ACC_R , Chuva_ACC ,	Chuva_ACC_V, Chuva_ACC_R, Rad_ACC_R ,	Rad_ACC ,	Rad_ACC_V, UR_Media, UR_V, UR_fld_m,	UR_R, Graus_dia_ciclo, Graus_dia_FLO)


rm(TabelabrutaIRR,TabelabrutaTA,Tabelabruta)

# Removendo os genótipos que não serão estudados

IRR = IRR[IRR$GENOTIPO %in% c("ALIANCA",	"AVAXI CL",	"BR IRGA 409",	"BR IRGA 410",	"BR IRGA 412",	"BR IRGA 414",	"BRS 7 TAIM",	"BRS A701 CL",	"BRS A702 CL",	"BRS A704",	"BRS ALVORADA",	"BRS BIGUA",	"BRS CATIANA",	"BRS CIRAD 302",	"BRS FORMOSO",	"BRS FRONTEIRA",	"BRS GUARA",	"BRS JABURU",	"BRS JACANA",	"BRS PAMPA",	"BRS PAMPEIRA",	"BRS PELOTA",	"BRS QUERENCIA",	"BRS SINUELO CL",	"BRS TROPICAL",	"BRSMG RUBELITA",	"CICA 8",	"CT8452",	"DIAMANTE",	"EEA34",	"EMPASC 101",	"EMPASC 102",	"EPAGRI 108",	"EPAGRI 109",	"EPAGRI97-01",	"EPAGRI97-05",	"EPAGRI97-06",	"H6",	"H7 CL",	"IAC1289",	"IAC1298",	"IAC1299",	"IAC1307",	"IAC1311",	"IAPAR 58",	"IRGA 417",	"IRGA 422 CL",	"IRGA 424",	"IRGA 424 RI",	"IRGA 425",	"IRGA 426",	"IRGA 427",	"IRGA 428",	"IRGA 429",	"IRGA 430",	"IRGA97-05",	"IRGA97-10",	"IRGA97-11",	"IRGA97-28",	"JAVAE",	"JEQUITIBA",	"MARAJO",	"METICA 1",	"MOXOTO",	"OUROMINAS",	"PR267",	"PR268",	"PR306",	"PR331",	"PR349",	"PR380",	"PR498",	"PR631",	"PR67",	"PUITA INTA CL",	"RORAIMA",	"SAO FRANCISCO",	"SC138",	"SC173",	"SC237",	"SC240",	"SC250",	"SCS 112",	"SCS 114 ANDOSAN",	"SCS 116 SATORU",	"SCS 121 CL",	"SCSBRS 111",	"SCSBRS 113 TIO TAKA",	"SCSBRS PIRACEMA",	"SG11551",	"URUCUI"),]
IRR = IRR[IRR$UF!="MT",]

# Filtrando e gerando médias

IRR_Medio<- IRR %>% group_by(ID_ENSAIO, GENOTIPO, REGIAO) %>% summarise(  FLO_M= mean(FLO_E),  latitude= mean(latitude), longitude = mean(longitude), Altitude = mean(Altitude), Tmax_Maxima = mean(Tmax_Maxima) ,Tmax_fld_m = mean(Tmax_fld_m ),	Tmax_R= mean( Tmax_R),	Tmax_ACC_R= mean(Tmax_ACC_R ), Tmax_Minima= mean(Tmax_Minima ),	Tmax_Media= mean( Tmax_Media),Tmax_V = mean(Tmax_V ),Tmax_ACC_V= mean(Tmax_ACC_V ),	Tmin_Maxima= mean(Tmin_Maxima ),Tmin_Minima = mean(Tmin_Minima ),	Tmin_Media = mean(Tmin_Media ),	Tmin_V = mean(Tmin_V ),	Tmin_ACC_V = mean(Tmin_ACC_V ), Tmin_fld_m = mean( Tmin_fld_m),	Tmin_R= mean(Tmin_R ),	Tmin_ACC_R = mean(Tmin_ACC_R ), Chuva_ACC = mean(Chuva_ACC ),	Chuva_ACC_V= mean(Chuva_ACC_V ), Chuva_ACC_R= mean(Chuva_ACC_R ), Rad_ACC_R = mean(Rad_ACC_R ),	Rad_ACC = mean(Rad_ACC ),	Rad_ACC_V= mean(Rad_ACC_V ), UR_Media= mean( UR_Media), UR_V= mean( UR_V), UR_fld_m= mean(UR_fld_m ),	UR_R= mean(UR_R ), Graus_dia_ciclo= mean(Graus_dia_ciclo ), Graus_dia_FLO= mean(Graus_dia_FLO ))

# separando por macrorregião

Centro_oeste<- subset(IRR_Medio, (REGIAO == "Centro-oeste")) # filtrando por região
```
```{r}
Temporario<- Centro_oeste[,c(-1,-3)]

```


```{r}
modelo_GAM_CENTRO_OESTE<- gam(FLO_M~ GENOTIPO, family = gaussian, data= Temporario)

Step1<-step.Gam(modelo_GAM_CENTRO_OESTE ,scope = list ( "latitude"=~1+ latitude ,"longitude"=~1+longitude , "Altitude"=~1+ Altitude, "Tmax_Maxima"=~1+ Tmax_Maxima +s(Tmax_Maxima , 4), "Tmax_fld_m"=~1+ Tmax_fld_m +s(Tmax_fld_m , 4), "Tmax_R"=~1+ Tmax_R +s(Tmax_R , 4), "Tmax_ACC_R"=~1+ Tmax_ACC_R +s(Tmax_ACC_R , 4), "Tmax_Minima"  =~1+ Tmax_Minima +s(Tmax_Minima , 4),    "Tmax_Media"=~1+ Tmax_Media +s(Tmax_Media , 4), "Tmax_V"=~1+ Tmax_V +s(Tmax_V , 4), "Tmax_ACC_V"=~1+ Tmax_ACC_V +s(Tmax_ACC_V , 4), "Tmin_Maxima"    =~1+ Tmin_Maxima +s(Tmin_Maxima , 4), "Tmin_Minima" =~1+ Tmin_Minima +s(Tmin_Minima , 4), "Tmin_Media"=~1+ Tmin_Media +s(Tmin_Media , 4), "Tmin_V"=~1+ Tmin_V +s(Tmin_V , 4), "Tmin_ACC_V"=~1+ Tmin_ACC_V +s(Tmin_ACC_V , 4), "Tmin_fld_m"=~1+ Tmin_fld_m +s(Tmin_fld_m , 4), "Tmin_R"=~1+ Tmin_R +s(Tmin_R , 4), "Tmin_ACC_R"=~1+ Tmin_ACC_R +s(Tmin_ACC_R , 4),  "Chuva_ACC"=~1+ Chuva_ACC +s(Chuva_ACC , 4), "Chuva_ACC_V"   =~1+ Chuva_ACC_V +s(Chuva_ACC_V , 4),   "Chuva_ACC_R"   =~1+ Chuva_ACC_R +s(Chuva_ACC_R , 4),   "Rad_ACC_R"=~1+ Rad_ACC_R +s(Rad_ACC_R , 4), "Rad_ACC"=~1+ Rad_ACC +s(Rad_ACC , 4), "Rad_ACC_V"=~1+ Rad_ACC_V +s(Rad_ACC_V , 4), "UR_Media" =~1+ UR_Media +s(UR_Media , 4),  "UR_V"=~1+ UR_V +s(UR_V , 4), "UR_fld_m"=~1+ UR_fld_m +s(UR_fld_m , 4), "UR_R"=~1+ UR_R +s(UR_R , 4), "Graus_dia_ciclo"=~1+ Graus_dia_ciclo +s(Graus_dia_ciclo , 4),  "Graus_dia_FLO"  =~1+ Graus_dia_FLO +s(Graus_dia_FLO, 4)))
   
```

```{r}
 detach("package:gam", unload = TRUE)
library(mgcv)
```

```{r}
Step1$formula
```

```{r}
modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) + Chuva_ACC_V + s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```
```{r}
modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) + s(Chuva_ACC_V) + s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```
```{r}
Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("BR IRGA 409" ,"BR IRGA 410"	,"BRS 7 TAIM"	,"BRS A701 CL"	,"BRS A702 CL"	,"BRS CIRAD 302"	,"BRS FRONTEIRA"	,"BRS JACANA"	,"BRS PELOTA"	,"BRS SINUELO CL"	,"EMPASC 102"	,"EPAGRI97-01"	,"EPAGRI97-05"	,"EPAGRI97-06"	,"IRGA 422 CL"	,"IRGA 424"	,"IRGA 424 RI"	,"IRGA 425"	,"IRGA 426"	,"IRGA97-11"	,"IRGA97-28"	,"JEQUITIBA"	,"PR306"	,"PR349"	,"PR498"	,"PR631"	,"SC240"	,"SC250"
)

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) + s(Chuva_ACC_V) + s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```

```{r}
modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) + s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```

```{r}
Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("IRGA 427","SCSBRS 111")

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) +  s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```
```{r}
Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("BRS PAMPA")

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) +  s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```
```{r}
Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("IAC1289")

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) +  s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```

```{r}
Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("PR67")

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_GAM_CENTRO_OESTE<- gam(FLO_M ~ GENOTIPO + s(Tmax_Minima) + Tmin_V + Tmin_ACC_V + 
    Tmin_R + s(Tmin_ACC_R) +  s(Rad_ACC) + 
    s(Graus_dia_FLO), family = gaussian, data = Temporario)

summary(modelo_GAM_CENTRO_OESTE)
```
```{r}
par(mfrow = c(2, 2))
gam.check(modelo_GAM_CENTRO_OESTE, old.style = T)
```

```{r}
plot(modelo_GAM_CENTRO_OESTE, rug = TRUE, residuals = TRUE,
     pch = 1, cex = 1)
```
```{r}
plot.gam(modelo_GAM_CENTRO_OESTE)
```

```{r}

Temporario<- Temporario

Temporario$`Yhat` <-predict ( modelo_GAM_CENTRO_OESTE, Temporario)
Temporario$`Y_yhat` = c(Temporario$FLO_M - Temporario$Yhat)


  
  
  boxplot(Temporario$Y_yhat, main = "Todos os genótipos", xlab = "Y - Yhat" , ylab = "Dias pós emergência", cex.lab = 1.5)
  plot(y = Temporario$FLO_M, x = Temporario$Yhat,  main = "Todos os genótipos", xlab = "Valores preditos", ylab = "Valores observados", pch = 20, 
     col = "black" , cex.lab = 1.5) 
```
 


# Comparação com o modelo linear

## Modelo LM selecionado

Removendo os pontos de alavancagem 57, 60, 70 e 116 antes do ajuste, partindo das variáveis qualitativas

```{r}

Temporario <- Centro_oeste[,c(-1,-3)] # retirando as vaiáveis REGIAO e ID_ENSAIO
Temporario<- Temporario[c(-57, -60,-70,-116),]


Genotipos  <- Temporario$GENOTIPO
SELECAO_GEN <- c("BR IRGA 409", "BR IRGA 410",	"BRS 7 TAIM",	"BRS A701 CL",	"BRS A702 CL",	"BRS CIRAD 302",	"BRS FRONTEIRA",	"BRS JACANA",	"BRS PAMPA",	"BRS PELOTA",	"BRS SINUELO CL",	"EMPASC 102",	"EPAGRI97-01",	"EPAGRI97-05",	"EPAGRI97-06",	"IAC1289",	"IRGA 417",	"IRGA 422 CL",	"IRGA 424",	"IRGA 424 RI",	"IRGA 425",	"IRGA 426",	"IRGA 427",	"IRGA 429",	"IRGA97-11",	"IRGA97-28",	"JEQUITIBA",	"PR306",	"PR349",	"PR498",	"PR631",	"SC240",	"SC250", "PR67","SCSBRS 111", "IAPAR 58", "SC237", "URUCUI" )

Temporario$GENOTIPO <- c(ifelse(Temporario$GENOTIPO %in% SELECAO_GEN, "AA" , Genotipos))

modelo_Centro_oeste<-lm(FLO_M~ GENOTIPO + longitude + Tmax_Maxima + Tmax_fld_m + Tmax_R + 
    Tmax_ACC_R + Tmax_Minima + Tmax_V + Tmax_ACC_V + Tmin_Maxima + 
    Tmin_Minima + Tmin_Media + Tmin_ACC_V + Tmin_fld_m + Tmin_R + 
    Tmin_ACC_R + Chuva_ACC_V , Temporario) 
summary(modelo_Centro_oeste)
```


## BIC


```{r}
BIC(modelo_GAM_CENTRO_OESTE)
BIC(modelo_Centro_oeste)
```




# Validação cruzada
```{r}

#for(i in 1:100) {
  
  treinamento = NULL
  predicao = NULL
  
  nomesGenotipos = unique(Centro_oeste$GENOTIPO)
  
  for (nomeGen in nomesGenotipos) {
    
    # Contando quantas vezes o genotipo aparece
    
    indexGen = which(Centro_oeste$GENOTIPO %in% nomeGen)
    
    # Verificando quantidade
    
    if (length(indexGen) <= 2) {
      
      # Adicionando informacao genotipo ao data.frame de trainemanto
      
      tempData = Centro_oeste[Centro_oeste$GENOTIPO == nomeGen, ]
      treinamento = rbind(treinamento, tempData)
      
      
    } else {
      
      # Genotipos que aparem mais de 3
      tempData = Centro_oeste[Centro_oeste$GENOTIPO == nomeGen, ]
      
      # Separando data.frame em treinamento e teste
      porcentagem = sample.split(tempData$GENOTIPO, SplitRatio = .70)
      
      # Treinamento
      treinamento = rbind(treinamento, subset(tempData, porcentagem == TRUE))
      
      # Predicao
      predicao = rbind(predicao, subset(tempData, porcentagem == FALSE))
      
    }
    
  }
  
#}

print(treinamento)
print(predicao)

```



```{r}

for (i in 1:100) {
  aux_ajuste<- NULL
  aux_pred <- NULL
  for (j in 1: ngenotipos) {
    aux<- nomes_genotipos[j]
    if (n_genotipos[j]< = 2  ) {
      todas as informaçoes desse genotipo entram no banco de dados de ajuste
      
    }
  }
set.seed(i)  # toda reamostra guarda semente para replicar 
aux<-sample.int(n = n_total,size = n_ajuste, replace = FALSE)  
  
}
table(Temporario$GENOTIPO)

modelo_GAM_CENTRO_OESTE$xlevels

modelo_Centro_oeste$xlevels
aux
```


